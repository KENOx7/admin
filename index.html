<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        ::selection { background-color: #3b82f6; color: white; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-6 text-gray-200">Admin Girişi</h2>
            <input type="password" id="password" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400" placeholder="Şifrəni daxil edin">
            <button id="login-button" class="w-full bg-blue-600 text-white py-3 rounded-full hover:bg-blue-700 transition duration-300 font-semibold text-lg shadow-md hover:scale-105">Daxil Ol</button>
            <p id="login-error" class="text-red-400 mt-4 text-sm hidden">Yanlış şifrə!</p>
        </div>
    </div>

    <div id="admin-panel" class="container mx-auto p-4 sm:p-6 hidden">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">İdarəetmə Paneli</h1>
                <button id="logout-button" class="bg-red-600 text-white px-6 py-2 rounded-full hover:bg-red-700 transition font-semibold shadow-md hover:scale-105">Çıxış</button>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h2 class="text-2xl font-bold mb-5 text-gray-200">Yeni Qayıb Əlavə Et</h2>
                    <div class="space-y-5">
                        <div>
                            <label for="student-select" class="block text-sm font-medium text-gray-400 mb-1">Tələbə seçin:</label>
                            <select id="student-select" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="subject-select" class="block text-sm font-medium text-gray-400 mb-1">Fənn seçin:</label>
                            <select id="subject-select" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="date-input" class="block text-sm font-medium text-gray-400 mb-1">Tarix:</label>
                            <input type="date" id="date-input" class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button id="add-absence-button" class="w-full bg-green-600 text-white py-3 rounded-full hover:bg-green-700 transition font-bold text-lg shadow-md hover:scale-105">
                            Qayıbı Yadda Saxla
                        </button>
                        <p id="success-message" class="text-green-400 mt-2 text-center font-medium hidden">Qayıb uğurla əlavə edildi!</p>
                    </div>
                </div>

                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h2 class="text-2xl font-bold mb-5 text-gray-200">Son Qayıblar</h2>
                    <div id="absences-list" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                        <p class="text-gray-500">Heç bir qayıb qeyd edilməyib.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-sm text-center p-8 transform transition-all">
            <h3 id="modal-text" class="text-lg font-medium mb-6 text-gray-200">Modal mətni buraya gələcək</h3>
            <div id="modal-buttons" class="flex justify-center gap-4">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8",
            authDomain: "davamiyyet-sistemi.firebaseapp.com",
            projectId: "davamiyyet-sistemi",
            storageBucket: "davamiyyet-sistemi.appspot.com",
            messagingSenderId: "773549402059",
            appId: "1:773549402059:web:25286906aa1d998041f84e",
            measurementId: "G-M3Y8QZCM8C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const ADMIN_PASSWORD = "admin123";

        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const customModal = document.getElementById('custom-modal');
        const modalText = document.getElementById('modal-text');
        const modalButtons = document.getElementById('modal-buttons');

        const students = ["İsayev Ramal Rəfayıl", "Qulamov Kamil Amil", "Abbaszadə Salman Məsud", "Heydərli Heydər Sabir", "Mikayılova Lalə Samir", "Seyidov Nurəli Mirnayıb", "Kübərov Rahid Mahmud", "Bayramov Məmməd Vaqif", "Həsənov Mənzər İlqar", "Rüstəmov Elgün Ceyhun", "Xasayeva Nərmin Azər", "İbalı Cəmilə Rəfail", "Mirzəyeva Nüşabə Hacıəli", "Muradova Leyla Qadir", "Əhmədov Kənan Ceyhun", "Sultanlı Nihad Sərhad", "Əsgərov Elnar Vüsal", "Hüseynli Nərgiz Mütəllim", "Mirişov Nihad Murad", "Ağalizadə Səid Elman", "Hüseynova Firuzə Sənan", "Ağakərimov Fəqan Alim", "Həsənova Cəmalə Sergey", "Əliyev Fuad Razim", "Orucov Nurlan Seymur"];
        const subjects = ["Ehtimal nəzəriyyəsi və statistika", "Sistem proqramlaşdırma", "XDIAK-3", "Verilənlər bazası sistemləri", "Kompüter arxitekturası-1", "Web sistemləri və texnologiyaları"];

        const studentSelect = document.getElementById('student-select');
        const subjectSelect = document.getElementById('subject-select');
        students.forEach(student => {
            studentSelect.innerHTML += `<option value="${student}">${student}</option>`;
        });
        subjects.forEach(subject => {
            subjectSelect.innerHTML += `<option value="${subject}">${subject}</option>`;
        });

        const bakuDate = new Date().toLocaleString("en-US", { timeZone: "Asia/Baku" });
        const baku = new Date(bakuDate);
        const yyyy = baku.getFullYear();
        const mm = String(baku.getMonth() + 1).padStart(2, "0");
        const dd = String(baku.getDate()).padStart(2, "0");
        document.getElementById("date-input").value = `${yyyy}-${mm}-${dd}`;

        function checkLogin() {
            if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                signInToFirebase();
            }
        }

        loginButton.addEventListener('click', () => {
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                checkLogin();
                loginError.classList.add('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('isAdminAuthenticated');
            loginScreen.classList.remove('hidden');
            adminPanel.classList.add('hidden');
        });

        async function signInToFirebase() {
             try { await signInAnonymously(auth); } catch (error) { console.error("Firebase anonim giriş xətası:", error); }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) { loadAbsences(); }
        });

        const addAbsenceButton = document.getElementById('add-absence-button');
        const successMessage = document.getElementById('success-message');

        addAbsenceButton.addEventListener('click', async () => {
            const student = studentSelect.value;
            const subject = subjectSelect.value;
            const date = document.getElementById('date-input').value;

            if (!student || !subject || !date) {
                showModal("Zəhmət olmasa bütün xanaları doldurun.", [{ text: "Bağla", class: "bg-gray-600 hover:bg-gray-700", onClick: hideModal }]);
                return;
            }

            try {
                await addDoc(collection(db, "qayiblar"), { usaqAdi: student, fenn: subject, tarix: date, timestamp: serverTimestamp() });
                successMessage.classList.remove('hidden');
                setTimeout(() => { successMessage.classList.add('hidden'); }, 3000);
            } catch (e) {
                console.error("Sənəd əlavə edilərkən xəta: ", e);
                showModal("Qayıb əlavə edilərkən xəta baş verdi.", [{ text: "Bağla", class: "bg-red-600 hover:bg-red-700", onClick: hideModal }]);
            }
        });

        const absencesList = document.getElementById('absences-list');
        function loadAbsences() {
            const q = query(collection(db, "qayiblar"), orderBy("timestamp", "desc"));
            onSnapshot(q, (querySnapshot) => {
                absencesList.innerHTML = querySnapshot.empty ? '<p class="text-gray-500">Heç bir qayıb qeyd edilməyib.</p>' : '';
                querySnapshot.forEach((doc) => {
                    const absence = doc.data();
                    const absenceElement = document.createElement('div');
                    absenceElement.className = 'flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700';
                    absenceElement.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-200">${absence.usaqAdi}</p>
                            <p class="text-sm text-gray-400">${absence.fenn} - <span class="font-mono">${absence.tarix}</span></p>
                        </div>
                        <button data-id="${doc.id}" class="delete-btn flex items-center justify-center w-8 h-8 bg-gray-700 text-red-400 rounded-full hover:bg-red-500 hover:text-white transition-all duration-200 text-xl font-bold">&times;</button>
                    `;
                    absencesList.appendChild(absenceElement);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.closest('button').getAttribute('data-id');
                        showModal("Bu qayıbı silmək istədiyinizə əminsiniz?", [
                            { 
                                text: "Bəli, sil", 
                                class: "bg-red-600 hover:bg-red-700", 
                                onClick: async () => {
                                    try {
                                        await deleteDoc(doc(db, "qayiblar", docId));
                                        hideModal();
                                    } catch (error) {
                                        console.error("Silmə zamanı xəta:", error);
                                        hideModal();
                                    }
                                }
                            },
                            { text: "Ləğv et", class: "bg-gray-600 hover:bg-gray-700", onClick: hideModal }
                        ]);
                    });
                });
            });
        }
        
        function showModal(text, buttons) {
            modalText.textContent = text;
            modalButtons.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `text-white px-6 py-2 rounded-full transition font-semibold shadow-md hover:scale-105 ${btnInfo.class}`;
                button.onclick = btnInfo.onClick;
                modalButtons.appendChild(button);
            });
            customModal.classList.remove('hidden');
        }

        function hideModal() {
            customModal.classList.add('hidden');
        }

        checkLogin();
    </script>
</body>
</html>
