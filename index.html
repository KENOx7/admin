<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli - 758/ITS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif
        }

        .tab-content {
            display: none
        }

        .tab-content.active {
            display: block
        }

        .tab-btn.active {
            background-color: #2563eb;
            color: #fff
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 antialiased font-sans">
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-6 text-gray-200">Admin Girişi</h2>
            <input type="password" id="password"
                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"
                placeholder="Şifrəni daxil edin">
            <button id="login-button"
                class="w-full bg-blue-600 text-white py-3 rounded-full hover:bg-blue-700 transition duration-300 font-semibold text-lg shadow-md hover:scale-105">Daxil
                Ol</button>
            <p id="login-error" class="text-red-400 mt-4 text-sm hidden">Yanlış şifrə!</p>
        </div>
    </div>
    <div id="admin-panel" class="container mx-auto p-4 sm:p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                İdarəetmə Paneli</h1>
            <button id="logout-button"
                class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm text-white font-bold">Çıxış</button>
        </div>
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 flex justify-between items-center">
            <div>
                <p class="text-gray-400 text-sm">Aktiv Semestr</p>
                <h2 id="active-semester-display" class="text-xl font-bold text-white">Yüklənir...</h2>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-sm">Qrup</p>
                <h2 class="text-xl font-bold text-blue-400">758/ITS</h2>
            </div>
        </div>
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
            <button
                class="tab-btn active px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-absences">Qayıblar</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-grades">Qiymətlər</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-schedule">Dərs Cədvəli</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-subjects">Fənlər</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-semester">Semestr</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-settings">Tənzimləmələr</button>
        </div>
        <div id="tab-absences" class="tab-content active space-y-6">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Qayıb Əlavə Et</h3>
                    <div class="space-y-4">
                        <select id="student-select"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Tələbə Seçin...</option>
                        </select>
                        <select id="subject-select-absence"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Fənn Seçin...</option>
                        </select>
                        <input type="date" id="date-input"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <button id="btn-add-absence"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition">Yadda
                            Saxla</button>
                    </div>
                </div>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Son Qayıblar</h3>
                    <div id="absences-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
        <div id="tab-grades" class="tab-content space-y-6">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Qiymət Əlavə Et</h3>
                    <div class="space-y-4">
                        <select id="student-select-grade"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Tələbə Seçin...</option>
                        </select>
                        <select id="subject-select-grade"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Fənn Seçin...</option>
                        </select>
                        <input type="number" id="grade-input" placeholder="Qiymət (məs: 5, 10, ...)" step="0.1" min="0"
                            max="100"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <button id="btn-add-grade"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition">Əlavə
                            Et</button>
                    </div>
                </div>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Mövcud Qiymətlər</h3>
                    <div id="grades-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
        <div id="tab-schedule" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Cədvələ Dərs Əlavə Et</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <select id="schedule-week-type"
                        class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <option value="both">Hər İkisi (ALT və ÜST)</option>
                        <option value="alt">ALT Həftə</option>
                        <option value="ust">ÜST Həftə</option>
                    </select>
                    <select id="schedule-day" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <option value="1">1. Bazar ertəsi</option>
                        <option value="2">2. Çərşənbə axşamı</option>
                        <option value="3">3. Çərşənbə</option>
                        <option value="4">4. Cümə axşamı</option>
                        <option value="5">5. Cümə</option>
                    </select>
                </div>
                <div class="space-y-4 mb-4">
                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="schedule-slot" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="1">1-ci cüt (08:00-09:20)</option>
                            <option value="2">2-ci cüt (09:35-10:55)</option>
                            <option value="3">3-cü cüt (11:10-12:30)</option>
                            <option value="4">4-cü cüt (12:45-14:05)</option>
                            <option value="5">5-ci cüt (14:20-15:40)</option>
                            <option value="6">6-cı cüt (15:55-17:15)</option>
                        </select>
                        <select id="schedule-subject"
                            class="md:col-span-2 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">Fənn Seçin...</option>
                        </select>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="schedule-type" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="mühazirə">Mühazirə</option>
                            <option value="seminar">Seminar</option>
                        </select>
                        <input type="text" id="schedule-teacher" placeholder="Müəllim..."
                            class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <input type="text" id="schedule-room" placeholder="Otaq..."
                            class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    </div>
                </div>
                <button id="btn-add-schedule"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition">Cədvələ
                    Əlavə Et</button>
            </div>
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Mövcud Cədvəl (Önizləmə)</h3>
                <div id="preview-schedule">
                    <p class="text-gray-500">Yüklənir...</p>
                </div>
            </div>
        </div>
        <div id="tab-subjects" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-blue-300">Fənn Əlavə Et</h2>
                <div class="flex gap-2">
                    <input type="text" id="new-subject-name" placeholder="Fənnin adı..."
                        class="bg-gray-700 text-white rounded p-2 flex-grow focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="new-subject-limit" placeholder="Limit" value="7" min="1" max="20"
                        class="bg-gray-700 text-white rounded p-2 w-20 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    <button id="btn-add-subject"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors">+</button>
                </div>
            </div>
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Aktiv Fənlər</h3>
                <ul id="subjects-list" class="list-disc list-inside text-gray-300 space-y-2"></ul>
            </div>
        </div>
        <div id="tab-semester" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 border-l-4 border-l-red-500">
                <h3 class="text-xl font-bold mb-4 text-red-400">Yeni Semestr Yarat</h3>
                <p class="text-gray-400 mb-4 text-sm">DİQQƏT: Yeni semestr yaratdıqda, cari aktiv semestr arxivlənəcək.
                </p>
                <div class="flex gap-4">
                    <input type="text" id="new-semester-name" placeholder="Məs: Payız 2024"
                        class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <button id="btn-create-semester"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 rounded-lg font-bold transition">Yarat və
                        Aktivləşdir</button>
                </div>
            </div>
        </div>
        <div id="tab-settings" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-yellow-500">Məlumatların Miqrasiyası</h3>
                <div class="space-y-4">
                    <div class="p-4 bg-gray-800 rounded border border-gray-600">
                        <h4 class="font-bold text-white mb-2">1. Tələbələri Köçür</h4>
                        <p class="text-xs text-gray-400 mb-3">Statik siyahıdakı tələbələri "students" kolleksiyasına
                            əlavə edər.</p>
                        <button id="btn-migrate-students"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-bold transition">Tələbələri
                            Köçür</button>
                    </div>
                    <div class="p-4 bg-gray-800 rounded border border-gray-600">
                        <h4 class="font-bold text-white mb-2">2. Köhnə Qayıbları Köçür</h4>
                        <p class="text-xs text-gray-400 mb-3">Köhnə "qayiblar" kolleksiyasını yeni "absences_log"a əlavə
                            edər.</p>
                        <button id="btn-migrate-absences"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-bold transition">Qayıbları
                            Köçür</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-subject-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl relative">
            <button onclick="closeEditModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h3 class="text-2xl font-bold mb-6 text-blue-400">Fənni Redaktə Et</h3>
            <input type="hidden" id="edit-subject-original-name">
            <div class="mb-4"><label class="block text-gray-400 text-sm mb-2">Fənnin Adı</label><input type="text"
                    id="edit-subject-name"
                    class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-6"><label class="block text-gray-400 text-sm mb-2">Limit</label><input type="number"
                    id="edit-subject-limit"
                    class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex justify-end gap-3"><button onclick="closeEditModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white font-medium transition">Ləğv
                    et</button><button onclick="saveEditedSubject()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Yadda
                    Saxla</button></div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { SystemManager } from "./firestore_manager.js";
        const firebaseConfig = { apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8", authDomain: "davamiyyet-sistemi.firebaseapp.com", projectId: "davamiyyet-sistemi", storageBucket: "davamiyyet-sistemi.appspot.com", messagingSenderId: "773549402059", appId: "1:773549402059:web:25286906aa1d998041f84e", measurementId: "G-M3Y8QZCM8C" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const manager = new SystemManager(db); const currentGroupId = "758_ITS";
        const loginScreen = document.getElementById('login-screen'), adminPanel = document.getElementById('admin-panel'), activeSemesterDisplay = document.getElementById('active-semester-display'), studentSelect = document.getElementById('student-select'), studentSelectGrade = document.getElementById('student-select-grade'), subjectSelectAbsence = document.getElementById('subject-select-absence'), subjectSelectGrade = document.getElementById('subject-select-grade'), subjectsList = document.getElementById('subjects-list'), absencesList = document.getElementById('absences-list'), gradesList = document.getElementById('grades-list');
        let activeSemesterId = null;
        let staticStudents = ["İsayev Ramal Rəfayıl", "Qulamov Kamil Amil", "Abbaszadə Salman Məsud", "Heydərli Heydər Sabir", "Mikayılova Lalə Samir", "Seyidov Nurəli Mirnayıb", "Kübərov Rahid Mahmud", "Bayramov Məmməd Vaqif", "Həsənov Mənzər İlqar", "Rüstəmov Elgün Ceyhun", "Xasayeva Nərmin Azər", "İbalı Cəmilə Rəfail", "Mirzəyeva Nüşabə Hacıəli", "Muradova Leyla Qadir", "Əhmədov Kənan Ceyhun", "Sultanlı Nihad Sərhad", "Əsgərov Elnar Vüsal", "Hüseynli Nərgiz Mütəllim", "Mirişov Nihad Murad", "Ağalizadə Səid Elman", "Hüseynova Firuzə Sənan", "Ağakərimov Fəqan Alim", "Əliyev Fuad Razim", "Orucov Nurlan Seymur"];
        document.getElementById('login-button').addEventListener('click', () => { if (document.getElementById('password').value === "admin123") { sessionStorage.setItem('isAdminAuthenticated', 'true'); checkLogin(); } else { document.getElementById('login-error').classList.remove('hidden'); } });
        document.getElementById('logout-button').addEventListener('click', () => { sessionStorage.removeItem('isAdminAuthenticated'); window.location.reload(); });
        function checkLogin() { if (sessionStorage.getItem('isAdminAuthenticated') === 'true') { loginScreen.classList.add('hidden'); adminPanel.classList.remove('hidden'); signInAnonymously(auth); } }
        checkLogin();
        onAuthStateChanged(auth, async (user) => { if (user) { await loadInitialData(); setupRealtimeListeners(); } });
        async function loadInitialData() {
            try {
                const semester = await manager.getActiveSemester();
                if (semester) {
                    activeSemesterId = semester.id;
                    activeSemesterDisplay.textContent = semester.name;
                    await loadSubjects();
                    await loadStudents();
                    await loadGroupSchedule();
                } else {
                    activeSemesterDisplay.textContent = "Aktiv Semestr Yoxdur";
                }
                document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
            } catch (e) {
                console.error(e);
                activeSemesterDisplay.textContent = "Bağlantı Xətası: " + e.message;
            }
        }
        async function loadSubjects() {
            if (!activeSemesterId) return;
            const result = await manager.getGroupSubjects(activeSemesterId, currentGroupId);
            const subjects = result.subjects || [], limits = result.limits || {};
            const subjectSelectSchedule = document.getElementById('schedule-subject');
            subjectSelectSchedule.innerHTML = '<option value="">Seçin...</option>';
            subjectSelectAbsence.innerHTML = '<option value="">Fənn seçin...</option>';
            subjectSelectGrade.innerHTML = '<option value="">Fənn seçin...</option>';
            subjects.forEach(sub => { subjectSelectSchedule.innerHTML += `<option value="${sub}">${sub}</option>`; subjectSelectAbsence.innerHTML += `<option value="${sub}">${sub}</option>`; subjectSelectGrade.innerHTML += `<option value="${sub}">${sub}</option>`; });
            subjectsList.innerHTML = subjects.map(s => {
                const limit = limits[s] || 7, safeName = s.replace(/'/g, "\\'");
                return `<li class="bg-gray-800 p-3 rounded flex justify-between items-center mb-2 border border-gray-700"><div><span class="font-bold text-white">${s}</span><span class="text-xs text-yellow-500 ml-2">(Limit: ${limit})</span></div><div><button onclick="window.editSubject('${safeName}', ${limit})" class="bg-blue-600 hover:bg-blue-500 text-white p-1 rounded mr-2 transition"><i class="ph ph-pencil-simple"></i></button><button onclick="window.deleteSubject('${safeName}')" class="bg-red-600 hover:bg-red-500 text-white p-1 rounded transition"><i class="ph ph-trash"></i></button></div></li>`;
            }).join('');
        }
        window.editSubject = (name, limit) => { const m = document.getElementById('edit-subject-modal'); document.getElementById('edit-subject-original-name').value = name; document.getElementById('edit-subject-name').value = name; document.getElementById('edit-subject-limit').value = limit; m.classList.remove('hidden'); };
        window.closeEditModal = () => document.getElementById('edit-subject-modal').classList.add('hidden');
        window.saveEditedSubject = async () => {
            const o = document.getElementById('edit-subject-original-name').value, n = document.getElementById('edit-subject-name').value, l = document.getElementById('edit-subject-limit').value;
            if (!n || !l) return alert("Doldurun!");
            try { await manager.updateSubject(activeSemesterId, currentGroupId, o, n, parseInt(l)); closeEditModal(); await loadSubjects(); } catch (e) { alert("Xəta: " + e); }
        };
        window.deleteSubject = async (n) => { if (confirm(`${n} silinsin?`)) try { await manager.deleteSubject(activeSemesterId, currentGroupId, n); await loadSubjects(); } catch (e) { alert("Xəta: " + e); } };
        async function loadStudents() {
            studentSelect.innerHTML = '<option value="">Tələbə Seçin...</option>';
            studentSelectGrade.innerHTML = '<option value="">Tələbə Seçin...</option>';
            const dbS = await manager.getAllStudents(currentGroupId);
            (dbS.length > 0 ? dbS : staticStudents).forEach(s => { studentSelect.innerHTML += `<option value="${s}">${s}</option>`; studentSelectGrade.innerHTML += `<option value="${s}">${s}</option>`; });
        }
        function setupRealtimeListeners() {
            const q = query(collection(db, "absences_log"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                absencesList.innerHTML = '';
                const validStudents = new Set();
                for (let opt of studentSelect.options) { if (opt.value) validStudents.add(opt.value); }
                let hasData = false;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.groupId && data.groupId !== currentGroupId) return;
                    if (!data.groupId && !validStudents.has(data.studentName)) return;
                    hasData = true;
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700';
                    el.innerHTML = `<div><p class="font-bold text-gray-200">${data.studentName}</p><p class="text-xs text-gray-400">${data.subject} | ${data.date}</p></div><button class="delete-btn text-red-500 hover:text-red-400 font-bold px-2">&times;</button>`;
                    el.querySelector('.delete-btn').onclick = () => deleteAbsence(doc.id);
                    absencesList.appendChild(el);
                });
                if (!hasData) absencesList.innerHTML = '<p class="text-gray-500">Qayıb yoxdur.</p>';
            });
            const qGrades = query(collection(db, "grades_log"), orderBy("timestamp", "desc"));
            onSnapshot(qGrades, (snapshot) => {
                gradesList.innerHTML = '';
                const validStudents = new Set();
                for (let opt of studentSelect.options) { if (opt.value) validStudents.add(opt.value); }
                let hasData = false;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.groupId && data.groupId !== currentGroupId) return;
                    if (!data.groupId && !validStudents.has(data.studentName)) return; // fallback
                    hasData = true;
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700';
                    el.innerHTML = `<div><p class="font-bold text-gray-200">${data.studentName}</p><p class="text-xs text-gray-400">${data.subject} | Qiymət: <strong class="text-blue-400">${data.grade}</strong></p></div><button class="delete-btn text-red-500 hover:text-red-400 font-bold px-2">&times;</button>`;
                    el.querySelector('.delete-btn').onclick = () => deleteGrade(doc.id);
                    gradesList.appendChild(el);
                });
                if (!hasData) gradesList.innerHTML = '<p class="text-gray-500">Qiymət yoxdur.</p>';
            });
        }
        document.getElementById('btn-create-semester').onclick = async () => { const n = document.getElementById('new-semester-name').value; if (n && confirm("Yeni semestr?")) { await manager.createSemester(n); window.location.reload(); } };
        document.getElementById('btn-add-subject').onclick = async () => { const n = document.getElementById('new-subject-name').value, l = document.getElementById('new-subject-limit').value || 7; if (n && activeSemesterId) { try { await manager.addSubjectToGroup(activeSemesterId, currentGroupId, n, l); document.getElementById('new-subject-name').value = ''; await loadSubjects(); await loadStudents(); await loadGroupSchedule(); } catch (e) { alert("Xəta: " + e.message); console.error(e); } } };
        document.getElementById('btn-add-schedule').onclick = async () => {
            const wt = document.getElementById('schedule-week-type').value, d = document.getElementById('schedule-day').value, sl = document.getElementById('schedule-slot').value, sub = document.getElementById('schedule-subject').value, ty = document.getElementById('schedule-type').value, t = document.getElementById('schedule-teacher').value, r = document.getElementById('schedule-room').value;
            if (!sub || !t || !r || !activeSemesterId) return alert("Doldurun!");
            const times = { "1": "08:00-09:20", "2": "09:35-10:55", "3": "11:10-12:30", "4": "12:45-14:05", "5": "14:20-15:40", "6": "15:55-17:15" };
            const lStr = `{${sl}} ${sub} (${ty}) - ${t} (${times[sl] || ""}, Otaq ${r})`;
            try {
                if (window.editingLesson) { await manager.updateLessonInSchedule(activeSemesterId, currentGroupId, window.editingLesson.week, window.editingLesson.day, window.editingLesson.originalString, lStr); cancelEditLesson(); }
                else { if (wt === 'both') { await manager.addLessonToSchedule(activeSemesterId, currentGroupId, 'alt', d, lStr); await manager.addLessonToSchedule(activeSemesterId, currentGroupId, 'ust', d, lStr); } else { await manager.addLessonToSchedule(activeSemesterId, currentGroupId, wt, d, lStr); } }
                loadGroupSchedule();
            } catch (e) { alert("Xəta: " + e.message); }
        };
        window.editingLesson = null;
        window.startEditLesson = (w, d, ls) => {
            window.editingLesson = { week: w, day: d, originalString: ls };
            try {
                let s = "1", rem = ls;
                if (ls.startsWith('{')) { const e = ls.indexOf('}'); s = ls.substring(1, e); rem = ls.substring(e + 1).trim(); }
                const ds = rem.split(" - "), lP = ds[0], rP = ds[1], tM = lP.match(/\(([^)]+)\)$/), ty = tM ? tM[1] : "", sub = lP.replace(` (${ty})`, "").trim(), lPS = rP.lastIndexOf(" ("), tea = rP.substring(0, lPS).trim(), loc = rP.substring(lPS + 2, rP.length - 1), rM = loc.match(/Otaq (.+)$/), room = rM ? rM[1] : "";
                document.getElementById('schedule-week-type').value = w; document.getElementById('schedule-day').value = d; document.getElementById('schedule-slot').value = s; document.getElementById('schedule-subject').value = sub; document.getElementById('schedule-type').value = ty; document.getElementById('schedule-teacher').value = tea; document.getElementById('schedule-room').value = room;
                const b = document.getElementById('btn-add-schedule'); b.textContent = "Dəyişikliyi Yadda Saxla"; b.classList.remove('bg-green-600', 'bg-blue-600'); b.classList.add('bg-blue-600');
                let c = document.getElementById('btn-cancel-edit'); if (!c) { c = document.createElement('button'); c.id = 'btn-cancel-edit'; c.textContent = "Ləğv et"; c.className = "bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded transition-colors ml-2"; c.onclick = cancelEditLesson; b.parentNode.appendChild(c); } c.classList.remove('hidden');
                document.getElementById('schedule-week-type').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) { console.error(e); }
        };
        window.cancelEditLesson = () => { window.editingLesson = null; document.getElementById('schedule-teacher').value = ''; document.getElementById('schedule-room').value = ''; const b = document.getElementById('btn-add-schedule'); b.textContent = "Cədvələ Əlavə Et"; b.classList.remove('bg-blue-600'); b.classList.add('bg-green-600'); const c = document.getElementById('btn-cancel-edit'); if (c) c.classList.add('hidden'); };
        async function loadGroupSchedule() {
            if (!activeSemesterId) return;
            const s = await manager.getGroupSchedule(activeSemesterId, currentGroupId), pc = document.getElementById('preview-schedule');
            if (!s) { pc.innerHTML = "<p>Cədvəl tapılmadı.</p>"; return; }
            let h = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            const rD = (w, dN, dC, l) => {
                if (!l || l.length === 0) return '';
                return `<div class="bg-gray-700 p-2 rounded mb-2"><div class="font-bold text-yellow-400 border-b border-gray-600 mb-1">${w.toUpperCase()} - ${dN}</div>${l.sort().map((ls, i) => {
                    let d = ls; if (ls.startsWith('{')) d = ls.substring(ls.indexOf('}') + 1).trim();
                    let sn = ls.startsWith('{') ? parseInt(ls.substring(1, ls.indexOf('}'))) : null;
                    const mn = (sn && sn > 3) ? (sn - 3) : (sn || i + 1), sl = ls.replace(/'/g, "\\'");
                    return `<div class="flex justify-between items-start text-sm bg-gray-800 p-1 rounded mb-1 border border-gray-700"><span><span class="font-bold text-gray-500 mr-2">${mn})</span>${d}</span><div><button onclick="window.startEditLesson('${w}', '${dC}', '${sl}')" class="text-blue-400 hover:text-white px-1 ml-2"><i class="ph ph-pencil-simple"></i></button><button onclick="deleteLesson('${w}', '${dC}', '${sl}')" class="text-red-500 hover:text-white px-1 ml-2"><i class="ph ph-trash"></i></button></div></div>`;
                }).join('')}</div>`;
            };
            const da = { "1": "Bazar ertəsi", "2": "Çərşənbə axşamı", "3": "Çərşənbə", "4": "Cümə axşamı", "5": "Cümə" };
            h += '<div class="border border-gray-600 p-2 rounded"><h3 class="text-center font-bold text-blue-300 mb-2">Alt Həftə</h3>'; for (let k in da) h += rD('alt', da[k], k, s.alt?.[k]); h += '</div>';
            h += '<div class="border border-gray-600 p-2 rounded"><h3 class="text-center font-bold text-green-300 mb-2">Üst Həftə</h3>'; for (let k in da) h += rD('ust', da[k], k, s.ust?.[k]); h += '</div></div>';
            pc.innerHTML = h;
        }
        window.deleteLesson = async (w, d, l) => { if (confirm("Silinsin?")) try { await manager.deleteLessonFromSchedule(activeSemesterId, currentGroupId, w, d, l); loadGroupSchedule(); } catch (e) { alert(e.message); } };
        document.getElementById('btn-add-absence').onclick = async () => { const st = studentSelect.value, sb = subjectSelectAbsence.value, dt = document.getElementById('date-input').value; if (!st || !sb || !dt) return alert("Doldurun!"); await manager.addAbsence(activeSemesterId, currentGroupId, st, sb, dt); alert("Yazıldı!"); };
        document.getElementById('btn-add-grade').onclick = async () => { const st = studentSelectGrade.value, sb = subjectSelectGrade.value, gr = document.getElementById('grade-input').value; if (!st || !sb || !gr) return alert("Doldurun!"); await manager.addGrade(activeSemesterId, currentGroupId, st, sb, gr); alert("Qiymət yazıldı!"); document.getElementById('grade-input').value = ''; };
        async function deleteAbsence(id) { if (confirm("Silinsin?")) await manager.deleteAbsenceLog(id); }
        async function deleteGrade(id) { if (confirm("Qiymət silinsin?")) await manager.deleteGrade(id); }
        document.getElementById('btn-migrate-students').onclick = async () => { if (confirm("Miqrasiya?")) { await manager.migrateStudents(staticStudents, currentGroupId); alert("Hazır!"); await loadStudents(); } };
        document.getElementById('btn-migrate-absences').onclick = async () => { if (confirm("Qayıblar bərpa edilsin?")) { const c = await manager.migrateOldAbsences(); alert(`${c} qayıb bərpa edildi.`); } };
        document.querySelectorAll('.tab-btn').forEach(b => { b.addEventListener('click', () => { document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); b.classList.add('active'); document.getElementById(b.dataset.tab).classList.add('active'); }); });
    </script>
</body>

</html>