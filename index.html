<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-btn.active {
            background-color: #2563eb;
            color: white;
        }
    </style>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body class="bg-gray-900 text-gray-200 antialiased font-sans">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-6 text-gray-200">Admin Girişi</h2>
            <input type="password" id="password"
                class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"
                placeholder="Şifrəni daxil edin">
            <button id="login-button"
                class="w-full bg-blue-600 text-white py-3 rounded-full hover:bg-blue-700 transition duration-300 font-semibold text-lg shadow-md hover:scale-105">Daxil
                Ol</button>
            <p id="login-error" class="text-red-400 mt-4 text-sm hidden">Yanlış şifrə!</p>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="container mx-auto p-4 sm:p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                İdarəetmə Paneli</h1>
            <button id="logout-button"
                class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm text-white font-bold">Çıxış</button>
        </div>

        <!-- Current Semester Info -->
        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-6 flex justify-between items-center">
            <div>
                <p class="text-gray-400 text-sm">Aktiv Semestr</p>
                <h2 id="active-semester-display" class="text-xl font-bold text-white">Yklənir...</h2>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-sm">Qrup</p>
                <h2 class="text-xl font-bold text-blue-400">758/ITS</h2>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
            <button
                class="tab-btn active px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-absences">Qayıblar</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-schedule">Dərs Cədvəli</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-subjects">Fənlər</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-semester">Semestr</button>
            <button
                class="tab-btn px-4 py-2 rounded-lg bg-gray-800 text-gray-400 hover:bg-gray-700 transition whitespace-nowrap"
                data-tab="tab-settings">Tənzimləmələr</button>
        </div>

        <!-- Tab Content: Absences -->
        <div id="tab-absences" class="tab-content active space-y-6">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Qayıb Əlavə Et</h3>
                    <div class="space-y-4">
                        <select id="student-select"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Tələbə Seçin...</option>
                        </select>
                        <select id="subject-select-absence"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                            <option value="">Fənn Seçin...</option>
                        </select>
                        <input type="date" id="date-input"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <button id="btn-add-absence"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition">Yadda
                            Saxla</button>
                    </div>
                </div>
                <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-xl font-bold mb-4">Son Qayıblar</h3>
                    <div id="absences-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Schedule -->
        <div id="tab-schedule" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Cədvələ Dərs Əlavə Et</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <select id="schedule-week-type"
                        class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <option value="both">Hər İkisi (ALT və ÜST)</option>
                        <option value="alt">ALT Həftə</option>
                        <option value="ust">ÜST Həftə</option>
                    </select>
                    <select id="schedule-day" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <option value="1">1. Bazar ertəsi</option>
                        <option value="2">2. Çərşənbə axşamı</option>
                        <option value="3">3. Çərşənbə</option>
                        <option value="4">4. Cümə axşamı</option>
                        <option value="5">5. Cümə</option>
                    </select>
                </div>

                <div class="space-y-4 mb-4">
                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="schedule-slot" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="1">1-ci cüt (08:00-09:20)</option>
                            <option value="2">2-ci cüt (09:35-10:55)</option>
                            <option value="3">3-cü cüt (11:10-12:30)</option>
                            <option value="4">4-cü cüt (12:45-14:05)</option>
                            <option value="5">5-ci cüt (14:20-15:40)</option>
                            <option value="6">6-cı cüt (15:55-17:15)</option>
                        </select>
                        <select id="schedule-subject"
                            class="md:col-span-2 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="">Fənn Seçin...</option>
                        </select>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4">
                        <select id="schedule-type" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                            <option value="mühazirə">Mühazirə</option>
                            <option value="seminar">Seminar</option>
                        </select>
                        <input type="text" id="schedule-teacher" placeholder="Müəllim..."
                            class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                        <input type="text" id="schedule-room" placeholder="Otaq..."
                            class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    </div>
                </div>

                <button id="btn-add-schedule"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition">Cədvələ
                    Əlavə Et</button>
            </div>
            <!-- Schedule Preview -->
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Mövcud Cədvəl (Önizləmə)</h3>
                <div id="preview-schedule">
                    <p class="text-gray-500">Yüklənir...</p>
                </div>
            </div>
        </div>

        <!-- Tab Content: Subjects -->
        <div id="tab-subjects" class="tab-content space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-blue-300">2. Fənn Əlavə Et</h2>
                <div class="flex gap-2">
                    <input type="text" id="new-subject-name" placeholder="Fənnin adı..."
                        class="bg-gray-700 text-white rounded p-2 flex-grow focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="new-subject-limit" placeholder="Limit" value="7" min="1" max="20"
                        class="bg-gray-700 text-white rounded p-2 w-20 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    <button id="btn-add-subject"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors">+</button>
                </div>
            </div>
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4">Aktiv Fənlər</h3>
                <ul id="subjects-list" class="list-disc list-inside text-gray-300 space-y-2"></ul>
            </div>
        </div>

        <!-- Tab Content: Semester -->
        <div id="tab-semester" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 border-l-4 border-l-red-500">
                <h3 class="text-xl font-bold mb-4 text-red-400">Yeni Semestr Yarat</h3>
                <p class="text-gray-400 mb-4 text-sm">DİQQƏT: Yeni semestr yaratdıqda, cari aktiv semestr arxivlənəcək.
                    Bütün cədvəl və qayıblar arxivdə qalacaq, yeni semestr üçün boş cədvəl açılacaq.</p>
                <div class="flex gap-4">
                    <input type="text" id="new-semester-name" placeholder="Məs: Payız 2024"
                        class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <button id="btn-create-semester"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 rounded-lg font-bold transition">Yarat və
                        Aktivləşdir</button>
                </div>
            </div>
        </div>

        <!-- Tab Content: Settings/Migration -->
        <div id="tab-settings" class="tab-content space-y-6">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-yellow-500">Məlumatların Miqrasiyası</h3>
                <p class="text-gray-400 mb-4">Köhnə sistemdən qalan statik tələbələri və qayıbları yeni verilənlər
                    bazasına köçürmək üçün aşağıdakı düymələrdən istifadə edin.</p>

                <div class="space-y-4">
                    <div class="p-4 bg-gray-800 rounded border border-gray-600">
                        <h4 class="font-bold text-white mb-2">1. Tələbələri Köçür</h4>
                        <p class="text-xs text-gray-400 mb-3">Statik siyahıdakı tələbələri "students" kolleksiyasına
                            əlavə edər.</p>
                        <button id="btn-migrate-students"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-bold transition">Tələbələri
                            Köçür</button>
                    </div>

                    <div class="p-4 bg-gray-800 rounded border border-gray-600">
                        <h4 class="font-bold text-white mb-2">2. Köhnə Qayıbları Köçür</h4>
                        <p class="text-xs text-gray-400 mb-3">Köhnə "qayiblar" kolleksiyasını yeni "absences_log"a əlavə
                            edər.</p>
                        <button id="btn-migrate-absences"
                            class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-bold transition">Qayıbları
                            Köçür</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Subject Modal -->
    <div id="edit-subject-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl relative">
            <button onclick="closeEditModal()"
                class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h3 class="text-2xl font-bold mb-6 text-blue-400">Fənni Redaktə Et</h3>

            <input type="hidden" id="edit-subject-original-name">

            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">Fənnin Adı</label>
                <input type="text" id="edit-subject-name"
                    class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-blue-500">
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2">Limit</label>
                <input type="number" id="edit-subject-limit"
                    class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-white focus:outline-none focus:border-blue-500">
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeEditModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white font-medium transition">Ləğv
                    et</button>
                <button onclick="saveEditedSubject()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white font-bold transition">Yadda
                    Saxla</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { SystemManager } from "./firestore_manager.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAtQ_laoPhn_31RgUFp5hkHPzAcYJSH9_8",
            authDomain: "davamiyyet-sistemi.firebaseapp.com",
            projectId: "davamiyyet-sistemi",
            storageBucket: "davamiyyet-sistemi.appspot.com",
            messagingSenderId: "773549402059",
            appId: "1:773549402059:web:25286906aa1d998041f84e",
            measurementId: "G-M3Y8QZCM8C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const manager = new SystemManager(db);
        const currentGroupId = "758_ITS";

        // UI References
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const activeSemesterDisplay = document.getElementById('active-semester-display');
        const studentSelect = document.getElementById('student-select');
        const subjectSelectAbsence = document.getElementById('subject-select-absence');
        const subjectsList = document.getElementById('subjects-list');
        const absencesList = document.getElementById('absences-list');

        let activeSemesterId = null;
        let staticStudents = ["İsayev Ramal Rəfayıl", "Qulamov Kamil Amil", "Abbaszadə Salman Məsud", "Heydərli Heydər Sabir", "Mikayılova Lalə Samir", "Seyidov Nurəli Mirnayıb", "Kübərov Rahid Mahmud", "Bayramov Məmməd Vaqif", "Həsənov Mənzər İlqar", "Rüstəmov Elgün Ceyhun", "Xasayeva Nərmin Azər", "İbalı Cəmilə Rəfail", "Mirzəyeva Nüşabə Hacıəli", "Muradova Leyla Qadir", "Əhmədov Kənan Ceyhun", "Sultanlı Nihad Sərhad", "Əsgərov Elnar Vüsal", "Hüseynli Nərgiz Mütəllim", "Mirişov Nihad Murad", "Ağalizadə Səid Elman", "Hüseynova Firuzə Sənan", "Ağakərimov Fəqan Alim", "Həsənova Cəmalə Sergey", "Əliyev Fuad Razim", "Orucov Nurlan Seymur"];

        // --- AUTH & INIT ---
        document.getElementById('login-button').addEventListener('click', () => {
            if (document.getElementById('password').value === "admin123") {
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                checkLogin();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminAuthenticated');
            window.location.reload();
        });

        function checkLogin() {
            if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                signInAnonymously(auth);
            }
        }
        checkLogin();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadInitialData();
                setupRealtimeListeners();
            }
        });

        async function loadInitialData() {
            const semester = await manager.getActiveSemester();
            if (semester) {
                activeSemesterId = semester.id;
                activeSemesterDisplay.textContent = semester.name;
                await loadSubjects();
                await loadSubjects();
                await loadStudents();
                await loadGroupSchedule();
            } else {
                activeSemesterDisplay.textContent = "Aktiv Semestr Yoxdur";
            }

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
        }

        async function loadSubjects() {
            if (!activeSemesterId) return;
            // Get subjects (and limits, though we just need names for select)
            const result = await manager.getGroupSubjects(activeSemesterId, currentGroupId);
            // Result is { subjects: [], limits: {} }
            const subjects = result.subjects || [];
            const limits = result.limits || {};

            const subjectSelectSchedule = document.getElementById('schedule-subject');
            // subjectSelectAbsence is global const

            subjectSelectSchedule.innerHTML = '<option value="">Seçin...</option>';
            subjectSelectAbsence.innerHTML = '<option value="">Fənn seçin...</option>';

            subjects.forEach(sub => {
                const opt1 = document.createElement('option');
                opt1.value = sub;
                opt1.textContent = sub;
                subjectSelectSchedule.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = sub;
                opt2.textContent = sub;
                subjectSelectAbsence.appendChild(opt2);
            });

            // Populate List with Edit/Delete
            subjectsList.innerHTML = subjects.map(s => {
                const limit = limits[s] || 7;
                const safeName = s.replace(/'/g, "\\'"); // Escape quotes
                return `
                <li class="bg-gray-800 p-3 rounded flex justify-between items-center mb-2 border border-gray-700">
                    <div>
                        <span class="font-bold text-white">${s}</span>
                        <span class="text-xs text-yellow-500 ml-2">(Limit: ${limit})</span>
                    </div>
                    <div>
                        <button onclick="window.editSubject('${safeName}', ${limit})" class="bg-blue-600 hover:bg-blue-500 text-white p-1 rounded mr-2 transition"><i class="ph ph-pencil-simple"></i></button>
                        <button onclick="window.deleteSubject('${safeName}')" class="bg-red-600 hover:bg-red-500 text-white p-1 rounded transition"><i class="ph ph-trash"></i></button>
                    </div>
                </li>`;
            }).join('');
        } // End loadSubjects

        // Modal Logic
        window.editSubject = (name, currentLimit) => {
            console.log("Edit requested for:", name);
            const modal = document.getElementById('edit-subject-modal');
            const nameInput = document.getElementById('edit-subject-name');
            const limitInput = document.getElementById('edit-subject-limit');
            const originalNameInput = document.getElementById('edit-subject-original-name');

            originalNameInput.value = name;
            nameInput.value = name;
            limitInput.value = currentLimit;

            modal.classList.remove('hidden');
        };

        window.closeEditModal = () => {
            document.getElementById('edit-subject-modal').classList.add('hidden');
        };

        window.saveEditedSubject = async () => {
            const originalName = document.getElementById('edit-subject-original-name').value;
            const newName = document.getElementById('edit-subject-name').value;
            const newLimit = document.getElementById('edit-subject-limit').value;
            const modal = document.getElementById('edit-subject-modal');

            if (!newName || !newLimit) {
                alert("Zəhmət olmasa bütün sahələri doldurun!");
                return;
            }

            try {
                await manager.updateSubject(activeSemesterId, currentGroupId, originalName, newName, parseInt(newLimit));
                modal.classList.add('hidden');
                await loadSubjects(); // Reload list
            } catch (e) {
                console.error(e);
                alert("Xəta baş verdi: " + e);
            }
        };

        window.deleteSubject = async (name) => {
            console.log("Delete requested for:", name);
            if (confirm(`${name} fənnini silmək istəyirsiniz?\nDiqqət: Bu fənnə aid cədvəl və qayıblar silinməyəcək (yalnız siyahıdan çıxarılır).`)) {
                try {
                    await manager.deleteSubject(activeSemesterId, currentGroupId, name);
                    await loadSubjects(); // Reload list
                } catch (e) {
                    console.error(e);
                    alert("Xəta: " + e);
                }
            }
        };

        async function loadStudents() {
            studentSelect.innerHTML = '<option value="">Tələbə Seçin...</option>';

            // Try to fetch from Firestore first
            const dbStudents = await manager.getAllStudents(currentGroupId);

            if (dbStudents.length > 0) {
                dbStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            } else {
                // Fallback to static if DB empty (pre-migration)
                staticStudents.forEach(s => {
                    studentSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }
        }

        function setupRealtimeListeners() {
            const q = query(collection(db, "absences_log"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                absencesList.innerHTML = snapshot.empty ? '<p class="text-gray-500">Qayıb yoxdur.</p>' : '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.groupId === "758_KM") return; // Filter out 758_KM

                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-800 p-3 rounded border border-gray-700';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-200">${data.studentName}</p>
                            <p class="text-xs text-gray-400">${data.subject} | ${data.date}</p>
                        </div>
                        <button class="delete-btn text-red-500 hover:text-red-400 font-bold px-2">&times;</button>
                    `;
                    el.querySelector('.delete-btn').onclick = () => deleteAbsence(doc.id);
                    absencesList.appendChild(el);
                });
            });
        }

        // --- ACTIONS ---

        // 1. Add Semester
        document.getElementById('btn-create-semester').onclick = async () => {
            const name = document.getElementById('new-semester-name').value;
            if (!name) return alert("Semestr adını daxil edin!");
            if (confirm("Yeni semestr yaradilsin?")) {
                await manager.createSemester(name);
                window.location.reload();
            }
        };

        // 2. Add Subject
        document.getElementById('btn-add-subject').onclick = async () => {
            const name = document.getElementById('new-subject-name').value;
            const limit = document.getElementById('new-subject-limit').value || 7;

            if (!name || !activeSemesterId) return;
            await manager.addSubjectToGroup(activeSemesterId, currentGroupId, name, limit);
            document.getElementById('new-subject-name').value = '';
            // Reset limit to default? Keep 7
            await loadSubjects();
            await loadStudents();
            await loadGroupSchedule();
        };

        // 3. Add Schedule
        document.getElementById('btn-add-schedule').onclick = async () => {
            const weekType = document.getElementById('schedule-week-type').value;
            const day = document.getElementById('schedule-day').value;

            const slot = document.getElementById('schedule-slot').value;
            const subject = document.getElementById('schedule-subject').value;
            const type = document.getElementById('schedule-type').value;
            const teacher = document.getElementById('schedule-teacher').value;
            const room = document.getElementById('schedule-room').value;

            if (!subject || !teacher || !room || !activeSemesterId) return alert("Bütün xanaları doldurun!");

            const times = {
                "1": "08:00-09:20",
                "2": "09:35-10:55",
                "3": "11:10-12:30",
                "4": "12:45-14:05",
                "5": "14:20-15:40",
                "6": "15:55-17:15"
            };
            const timeStr = times[slot] || "";

            // Format: "Subject (Type) - Teacher (Time, Otaq Room)"
            const lessonString = `{${slot}} ${subject} (${type}) - ${teacher} (${timeStr}, Otaq ${room})`;

            try {
                if (window.editingLesson) {
                    // UPDATE MODE
                    await manager.updateLessonInSchedule(
                        activeSemesterId,
                        currentGroupId,
                        window.editingLesson.week,
                        window.editingLesson.day,
                        window.editingLesson.originalString,
                        lessonString
                    );
                    alert("Dərs yeniləndi!");
                    cancelEditLesson();
                } else {
                    // CREATE MODE
                    if (weekType === 'both') {
                        await manager.addLessonToSchedule(activeSemesterId, currentGroupId, 'alt', day, lessonString);
                        await manager.addLessonToSchedule(activeSemesterId, currentGroupId, 'ust', day, lessonString);
                    } else {
                        await manager.addLessonToSchedule(activeSemesterId, currentGroupId, weekType, day, lessonString);
                    }
                    // Clear inputs
                    document.getElementById('schedule-teacher').value = '';
                    document.getElementById('schedule-room').value = '';
                    alert("Cədvələ əlavə edildi!");
                }

                loadGroupSchedule(); // Refresh preview
            } catch (e) {
                console.error(e);
                alert("Xəta: " + (e.message || e));
            }
        };

        // Edit Lesson State
        window.editingLesson = null;

        window.startEditLesson = (week, day, lessonStr) => {
            console.log("Editing:", lessonStr);
            window.editingLesson = { week, day, originalString: lessonStr };

            // Parse lesson string to populate form
            // Format: "{slot} Subject (Type) - Teacher (Time, Otaq Room)"
            // Example: "{1} Math (Lec) - John Doe (08:00-09:20, Otaq 101)"

            try {
                let slot = "1";
                let remainder = lessonStr;

                if (lessonStr.startsWith('{')) {
                    const endIdx = lessonStr.indexOf('}');
                    slot = lessonStr.substring(1, endIdx);
                    remainder = lessonStr.substring(endIdx + 1).trim();
                }

                // Split by " (" for type?
                // remainder: "Math (Lec) - John Doe (08:00-09:20, Otaq 101)"
                const typeStart = remainder.lastIndexOf(" (");
                // wait, this is tricky because type is also inside ().
                // Let's rely on dash: " - "
                const dashSplit = remainder.split(" - ");
                const leftPart = dashSplit[0]; // "Math (Lec)"
                const rightPart = dashSplit[1]; // "John Doe (08:00-09:20, Otaq 101)"

                const typeMatch = leftPart.match(/\(([^)]+)\)$/);
                const type = typeMatch ? typeMatch[1] : ""; // "Lec"
                const subject = leftPart.replace(` (${type})`, "").trim();

                // rightPart: "John Doe (Time, Otaq Room)"
                const lastParenStart = rightPart.lastIndexOf(" (");
                const teacher = rightPart.substring(0, lastParenStart).trim();
                const locationPart = rightPart.substring(lastParenStart + 2, rightPart.length - 1); // "Time, Otaq Room"

                // locationPart: "08:00-09:20, Otaq 101"
                // Extract Room
                const roomMatch = locationPart.match(/Otaq (.+)$/);
                const room = roomMatch ? roomMatch[1] : "";

                // Set Values
                document.getElementById('schedule-week-type').value = week; // Can't edit week for existing lesson easily via dropdown if we strict check, but fine.
                document.getElementById('schedule-day').value = day;
                document.getElementById('schedule-slot').value = slot;
                document.getElementById('schedule-subject').value = subject;
                document.getElementById('schedule-type').value = type;
                document.getElementById('schedule-teacher').value = teacher;
                document.getElementById('schedule-room').value = room;

                // UI Update
                const btn = document.getElementById('btn-add-schedule');
                btn.textContent = "Dəyişikliyi Yadda Saxla";
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                // Add Cancel Button if not exists
                let cancelBtn = document.getElementById('btn-cancel-edit');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'btn-cancel-edit';
                    cancelBtn.textContent = "Ləğv et";
                    cancelBtn.className = "bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded transition-colors ml-2";
                    cancelBtn.onclick = cancelEditLesson;
                    btn.parentNode.appendChild(cancelBtn);
                }
                cancelBtn.classList.remove('hidden');

                // Scroll to form
                const formEl = document.getElementById('schedule-week-type');
                if (formEl) formEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (e) {
                console.error("Parse error", e);
                alert("Dərsi parse etmək olmadı: " + e);
            }
        };

        window.cancelEditLesson = () => {
            window.editingLesson = null;

            // Reset Form Defaults
            document.getElementById('schedule-teacher').value = '';
            document.getElementById('schedule-room').value = '';

            // Reset Button
            const btn = document.getElementById('btn-add-schedule');
            btn.textContent = "Cədvələ Əlavə Et";
            btn.classList.add('bg-green-600', 'hover:bg-green-700');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

            const cancelBtn = document.getElementById('btn-cancel-edit');
            if (cancelBtn) cancelBtn.classList.add('hidden');
        };

        // Load Schedule Preview
        async function loadGroupSchedule() {
            if (!activeSemesterId) return;
            const schedule = await manager.getGroupSchedule(activeSemesterId, currentGroupId);
            const previewContainer = document.getElementById('preview-schedule');

            if (!schedule) {
                previewContainer.innerHTML = "<p>Cədvəl tapılmadı.</p>";
                return;
            }

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

            // Helper to render a day
            const renderDay = (week, dayName, dayCode, lessons) => {
                if (!lessons || lessons.length === 0) return '';
                // Sort lessons? They are strings, maybe just display as is 
                // or try to keep input order. They are array pushed..
                return `
                    <div class="bg-gray-700 p-2 rounded mb-2">
                        <div class="font-bold text-yellow-400 border-b border-gray-600 mb-1">${week.toUpperCase()} - ${dayName}</div>
                        ${lessons.sort().map((l, idx) => {
                    // l might be "{1} Math..." or "1) Math..." (legacy)
                    let display = l;
                    if (l.startsWith('{')) {
                        display = l.substring(l.indexOf('}') + 1).trim();
                    }
                    // Show shift-based numbering for preview
                    let slotNum = null;
                    if (l.startsWith('{')) {
                        const endIdx = l.indexOf('}');
                        slotNum = parseInt(l.substring(1, endIdx));
                    }
                    const mappedNum = (slotNum && slotNum > 3) ? (slotNum - 3) : (slotNum || idx + 1);

                    // Parse for Edit
                    // Format: "{1} Math (Lec) - Teacher (08:00..., Otaq 101)"
                    const safeLesson = l.replace(/'/g, "\\'");

                    return `
                            <div class="flex justify-between items-start text-sm bg-gray-800 p-1 rounded mb-1 border border-gray-700">
                                <span><span class="font-bold text-gray-500 mr-2">${mappedNum})</span>${display}</span>
                                <div>
                                    <button onclick="window.startEditLesson('${week}', '${dayCode}', '${safeLesson}')" class="text-blue-400 hover:text-white px-1 ml-2"><i class="ph ph-pencil-simple"></i></button>
                                    <button onclick="deleteLesson('${week}', '${dayCode}', '${safeLesson}')" class="text-red-500 hover:text-white px-1 ml-2"><i class="ph ph-trash"></i></button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
            };

            const days = { "1": "Bazar ertəsi", "2": "Çərşənbə axşamı", "3": "Çərşənbə", "4": "Cümə axşamı", "5": "Cümə" };

            // Alt
            html += '<div class="border border-gray-600 p-2 rounded"> <h3 class="text-center font-bold text-blue-300 mb-2">Alt Həftə</h3>';
            for (let d in days) {
                html += renderDay('alt', days[d], d, schedule.alt?.[d]);
            }
            html += '</div>';

            // Ust
            html += '<div class="border border-gray-600 p-2 rounded"> <h3 class="text-center font-bold text-green-300 mb-2">Üst Həftə</h3>';
            for (let d in days) {
                html += renderDay('ust', days[d], d, schedule.ust?.[d]);
            }
            html += '</div>';

            html += '</div>';
            previewContainer.innerHTML = html;
        }

        // Expose delete to global scope
        window.deleteLesson = async (week, day, lessonStr) => {
            if (!confirm("Bu dərs silinsin?")) return;
            try {
                await manager.deleteLessonFromSchedule(activeSemesterId, currentGroupId, week, day, lessonStr);
                loadGroupSchedule();
            } catch (e) {
                alert("Xəta: " + e.message);
            }
        };

        // 4. Add Absence
        document.getElementById('btn-add-absence').onclick = async () => {
            const student = studentSelect.value;
            const subject = subjectSelectAbsence.value;
            const date = document.getElementById('date-input').value;
            if (!student || !subject || !date || !activeSemesterId) return alert("Məlumatları tam doldurun!");
            await manager.addAbsence(activeSemesterId, student, subject, date);
            alert("Qayıb yazıldı!");
        };

        async function deleteAbsence(id) {
            if (confirm("Silinsin?")) await manager.deleteAbsenceLog(id);
        }

        // --- MIGRATION ---
        document.getElementById('btn-migrate-students').onclick = async () => {
            if (confirm("Tələbələr koçürülsün?")) {
                await manager.migrateStudents(staticStudents, currentGroupId);
                alert("Hazırdır!");
                await loadStudents();
            }
        };

        document.getElementById('btn-migrate-absences').onclick = async () => {
            if (confirm("Qayıblar bərpa edilsin?")) {
                const c = await manager.migrateOldAbsences();
                alert(`${c} qayıb bərpa edildi.`);
            }
        };

        // --- TABS ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
    </script>
</body>

</html>
